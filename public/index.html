<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather - Vector Tiles</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div id='map'></div>
    
    <div class="controls">
        <div class="control-group">
            <label for="hour-slider">Forecast Hour:</label>
            <input type="range" id="hour-slider" min="1" max="51" value="1">
            <span id="hour-display">Hour 1</span>
        </div>
        
        <div class="control-group">
            <label for="opacity-slider">Opacity:</label>
            <input type="range" id="opacity-slider" min="0" max="100" value="70">
            <span id="opacity-display">90%</span>
        </div>
        
        <div class="control-group">
            <label for="pitch-slider">3D View Angle:</label>
            <input type="range" id="pitch-slider" min="0" max="60" value="15">
            <span id="pitch-display">15°</span>
        </div>
        
        <div class="control-group">
            <label for="terrain-slider">Terrain Exaggeration:</label>
            <input type="range" id="terrain-slider" min="0" max="3" step="0.1" value="1.5">
            <span id="terrain-display">1.5x</span>
        </div>
    </div>

    <div class="custom-select-wrapper" id="forecast-type-wrapper">
        <!-- Custom dropdown will be generated here -->
    </div>
    
    <div class="legend" id="legend">
        <h4>Legend</h4>
        <div id="legend-content"></div>
    </div>

    <script>
        // Configuration for forecast types, now with icons
        const forecastConfigs = {
            temperature: {
                name: 'Temperature',
                unit: '°C',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path></svg>',
                colorStops: [
                    [-20, '#000080'], [-10, '#0000ff'], [0, '#00ffff'], [10, '#00ff00'],
                    [20, '#ffff00'], [30, '#ff8000'], [40, '#ff0000']
                ]
            },
            cloud_cover: {
                name: 'Cloud Cover',
                unit: '%',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>',
                colorStops: [
                    [0, 'transparent'], [25, 'rgba(255,255,255, 0.2)'], [50, 'rgba(255,255,255, 0.3)'],
                    [75, 'rgba(255,255,255, 0.5)'], [100, 'rgba(255,255,255, 0.8)']
                ]
            },
            rainfall_accumulation: {
                name: 'Rainfall',
                unit: 'mm',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="19" x2="8" y2="21"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="16" y1="19" x2="16" y2="21"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>',
                colorStops: [
                    [0, 'transparent'], [1, '#e6f3ff'], [5, '#b3d9ff'], [10, '#66b3ff'],
                    [20, '#0080ff'], [50, '#0040cc']
                ]
            },
            humidity: {
                name: 'Humidity',
                unit: '%',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>',
                colorStops: [
                    [0, '#8B4513'], [20, '#DAA520'], [40, '#FFFF00'], [60, '#90EE90'],
                    [80, '#0000FF'], [100, '#000080']
                ]
            },
            comfort_index: {
                name: 'Comfort Index',
                unit: '/10',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>',
                colorStops: [
                  [0, '#00ff80'], [2, '#00ff00'], [4, '#80ff00'], [6, '#ffff00'],
                  [8, '#ff8000'], [10, '#ff0000']
                ]
            }
        };

        // Initialize map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-v9',
            center: [2.8948, 42.6886],
            zoom: 7.3,
            minZoom: 7.3,
            pitch: 15,
            bearing: 0,
            antialias: false,
            accessToken: 'pk.eyJ1IjoibWljaGFlbHZpbGxlbmV1dmUiLCJhIjoiY201MHlqZ2h2MXpmaDJqcXc3cHNka2xmeiJ9.aam0u_YExa5to859TlZCyg'
        });

        let currentForecastType = 'temperature';
        let currentHour = 1;

        function createCustomDropdown() {
            const wrapper = document.getElementById('forecast-type-wrapper');
            const select = document.createElement('div');
            select.className = 'custom-select';

            const trigger = document.createElement('div');
            trigger.className = 'custom-select-trigger';
            select.appendChild(trigger);
            
            const options = document.createElement('div');
            options.className = 'custom-options';

            Object.keys(forecastConfigs).forEach(key => {
                const config = forecastConfigs[key];
                const option = document.createElement('div');
                option.className = 'custom-option';
                option.dataset.value = key;
                option.innerHTML = `<span class="icon">${config.icon}</span><span>${config.name}</span>`;
                
                option.addEventListener('click', () => {
                    currentForecastType = key;
                    updateSelectedOption(key);
                    select.classList.remove('open');
                    updateWeatherLayer();
                    updateLegend();
                });
                options.appendChild(option);
            });

            select.appendChild(options);
            wrapper.appendChild(select);

            trigger.addEventListener('click', () => {
                select.classList.toggle('open');
            });
            
            document.addEventListener('click', (e) => {
                if (!select.contains(e.target)) {
                    select.classList.remove('open');
                }
            });

            updateSelectedOption(currentForecastType);
        }
        
        function updateSelectedOption(key) {
            const config = forecastConfigs[key];
            const trigger = document.querySelector('.custom-select-trigger');
            trigger.innerHTML = `<span class="icon">${config.icon}</span><span>${config.name}</span><div class="arrow"></div>`;
        }

        map.on('load', function() {
            console.log('Map loaded, initializing 3D features and weather layers...');
            
            createCustomDropdown();
            add3DTerrain();
            addWeatherSource();
            addWeatherLayer();
            updateLegend();
            addInteractivity();
        });

        map.on('error', function(e) {
            console.error('Map error:', e);
        });

        map.on('sourcedata', function(e) {
            if (e.sourceId === 'weather-data') {
                console.log('Weather data source event:', e.dataType);
                if (e.isSourceLoaded) {
                    console.log('Weather data source loaded successfully');
                }
            }
        });

        function add3DTerrain() {
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
            
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
            
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 0.0],
                    'sky-atmosphere-sun-intensity': 15
                }
            });
        }

        function addWeatherSource() {
            const hourStr = currentHour.toString().padStart(2, '0');
            const tileUrl = `https://api.mistral.earth/tiles/arome/${currentForecastType}/${hourStr}/{z}/{x}/{y}.pbf`;
            
            console.log('Adding weather source with URL:', tileUrl);
            
            map.addSource('weather-data', {
                type: 'vector',
                tiles: [tileUrl],
                minzoom:7,
                maxzoom: 9
            });
        }

        function addWeatherLayer() {
            const config = forecastConfigs[currentForecastType];
            
            const colorExpression = ['interpolate', ['linear'], ['get', 'value']];
            config.colorStops.forEach(([value, color]) => {
                colorExpression.push(value, color);
            });

            const sourceLayerName = `${currentForecastType}_${currentHour.toString().padStart(2, '0')}`;

            console.log('Adding weather layer with source-layer:', sourceLayerName);

            map.addLayer({
                id: 'weather-layer',
                type: 'fill',
                source: 'weather-data',
                'source-layer': sourceLayerName,
                paint: {
                    'fill-color': colorExpression,
                    'fill-opacity': 0.9
                }
            });
        }

        function updateWeatherLayer() {
            const hourStr = currentHour.toString().padStart(2, '0');
            const config = forecastConfigs[currentForecastType];
            
            map.getSource('weather-data').setTiles([
                `https://api.mistral.earth/tiles/arome/${currentForecastType}/${hourStr}/{z}/{x}/{y}.pbf`
            ]);
            
            if (map.getLayer('weather-layer')) {
                map.removeLayer('weather-layer');
            }
            
            const newSourceLayer = `${currentForecastType}_${hourStr}`;
            
            const colorExpression = ['interpolate', ['linear'], ['get', 'value']];
            config.colorStops.forEach(([value, color]) => {
                colorExpression.push(value, color);
            });

            map.addLayer({
                id: 'weather-layer',
                type: 'fill',
                source: 'weather-data',
                'source-layer': newSourceLayer,
                paint: {
                    'fill-color': colorExpression,
                    'fill-opacity': document.getElementById('opacity-slider').value / 100
                }
            });
            setupLayerInteractivity();
        }

        function addInteractivity() {
            setupLayerInteractivity();
        }

        function setupLayerInteractivity() {
            map.off('click', 'weather-layer');
            map.off('mouseenter', 'weather-layer');
            map.off('mouseleave', 'weather-layer');

            map.on('click', 'weather-layer', function(e) {
                const properties = e.features[0].properties;
                const config = forecastConfigs[currentForecastType];
                
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(`
                        <div>
                            <strong>${config.name}</strong><br>
                            Value: ${properties.value} ${config.unit}<br>
                            Coordinates: ${e.lngLat.lat.toFixed(3)}, ${e.lngLat.lng.toFixed(3)}
                        </div>
                    `)
                    .addTo(map);
            });

            map.on('mouseenter', 'weather-layer', function() {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'weather-layer', function() {
                map.getCanvas().style.cursor = '';
            });
        }

        function updateLegend() {
            const config = forecastConfigs[currentForecastType];
            const legendContent = document.getElementById('legend-content');
            
            legendContent.innerHTML = '';
            
            config.colorStops.forEach(([value, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <span>${value} ${config.unit}</span>
                `;
                legendContent.appendChild(item);
            });
        }

        document.getElementById('hour-slider').addEventListener('input', function(e) {
            currentHour = parseInt(e.target.value);
            document.getElementById('hour-display').textContent = `Hour ${currentHour}`;
            updateWeatherLayer();
        });

        document.getElementById('opacity-slider').addEventListener('input', function(e) {
            const opacity = e.target.value / 100;
            document.getElementById('opacity-display').textContent = `${e.target.value}%`;
            map.setPaintProperty('weather-layer', 'fill-opacity', opacity);
        });

        document.getElementById('pitch-slider').addEventListener('input', function(e) {
            const pitch = parseInt(e.target.value);
            document.getElementById('pitch-display').textContent = `${pitch}°`;
            map.setPitch(pitch);
        });

        document.getElementById('terrain-slider').addEventListener('input', function(e) {
            const exaggeration = parseFloat(e.target.value);
            document.getElementById('terrain-display').textContent = `${exaggeration}x`;
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': exaggeration });
        });
    </script>
</body>
</html>